<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="コリドール">
<meta name="theme-color" content="#020810">
<meta name="description" content="2人で遊べる戦略ボードゲーム コリドール">
<link rel="manifest" href="manifest.json">
<link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
<link rel="apple-touch-icon" href="icon-192.png">
<title>コリドール</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;700;900&family=Inter:wght@400;600;700;900&family=Zen+Maru+Gothic:wght@400;700;900&family=DotGothic16&display=swap');

* { margin: 0; padding: 0; box-sizing: border-box; }

html, body {
  width: 100%; height: 100%;
  overflow: hidden;
  overscroll-behavior: none;
  -webkit-overflow-scrolling: touch;
}

body {
  background: var(--bg);
  color: var(--text);
  font-family: var(--font);
  display: flex;
  justify-content: center;
  align-items: flex-end;
  min-height: 100vh;
  min-height: -webkit-fill-available;
  touch-action: manipulation;
  -webkit-tap-highlight-color: transparent;
  -webkit-touch-callout: none;
  -webkit-user-select: none;
  user-select: none;
  position: relative;
  overflow: hidden;
}

/* Star field */
body::before {
  content: '';
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background:
    radial-gradient(1px 1px at 10% 20%, rgba(255,255,255,0.8), transparent),
    radial-gradient(1px 1px at 25% 45%, rgba(255,255,255,0.6), transparent),
    radial-gradient(1px 1px at 40% 15%, rgba(255,255,255,0.5), transparent),
    radial-gradient(1px 1px at 55% 70%, rgba(255,255,255,0.7), transparent),
    radial-gradient(1px 1px at 70% 35%, rgba(255,255,255,0.4), transparent),
    radial-gradient(1px 1px at 85% 80%, rgba(255,255,255,0.6), transparent),
    radial-gradient(1px 1px at 15% 85%, rgba(255,255,255,0.5), transparent),
    radial-gradient(1px 1px at 90% 10%, rgba(255,255,255,0.8), transparent),
    radial-gradient(1px 1px at 33% 33%, rgba(255,255,255,0.7), transparent),
    radial-gradient(1px 1px at 62% 52%, rgba(255,255,255,0.6), transparent),
    radial-gradient(2px 2px at 20% 72%, var(--star1), transparent),
    radial-gradient(2px 2px at 75% 22%, var(--star2), transparent),
    radial-gradient(2px 2px at 50% 50%, var(--star3), transparent);
  animation: twinkle 4s ease-in-out infinite alternate;
  pointer-events: none;
  z-index: 0;
}
@keyframes twinkle { 0% { opacity: 0.7; } 100% { opacity: 1; } }

body::after {
  content: '';
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background:
    radial-gradient(ellipse at 15% 50%, var(--nebula1) 0%, transparent 50%),
    radial-gradient(ellipse at 85% 50%, var(--nebula2) 0%, transparent 50%);
  pointer-events: none;
  z-index: 0;
}

#app {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-end;
  gap: 4px;
  padding: calc(8px + env(safe-area-inset-top)) calc(4px + env(safe-area-inset-right)) calc(8px + env(safe-area-inset-bottom)) calc(4px + env(safe-area-inset-left));
  width: 100%;
  max-width: 600px;
  height: 100vh;
  height: 100dvh;
  overflow: visible;
  position: relative;
  z-index: 1;
}

.player-zone { width: 100%; display: flex; flex-direction: column; gap: 4px; flex-shrink: 0; }
.player-zone.p2-zone { transform: rotate(180deg); }

.player-panel {
  width: 100%; padding: 6px 10px; border-radius: 6px;
  background: var(--panel-bg); border: 1px solid var(--panel-border);
  transition: all 0.4s cubic-bezier(.4,0,.2,1);
  position: relative; overflow: hidden;
}
.player-panel::before {
  content: ''; position: absolute; top: 0; left: 0; right: 0;
  height: 2px; opacity: 0; transition: opacity 0.4s;
}
.player-panel.p1::before { background: linear-gradient(90deg, var(--p1), var(--p1-light), var(--p1)); box-shadow: 0 0 10px var(--p1); }
.player-panel.p2::before { background: linear-gradient(90deg, var(--p2), var(--p2-light), var(--p2)); box-shadow: 0 0 10px var(--p2); }
.player-panel.active::before { opacity: 1; }
.player-panel.active.p1 { border-color: var(--p1-dim); box-shadow: 0 0 20px var(--p1-glow); }
.player-panel.active.p2 { border-color: var(--p2-dim); box-shadow: 0 0 20px var(--p2-glow); }

.panel-row { display: flex; align-items: center; gap: 6px; }
.player-icon {
  width: 24px; height: 24px; border-radius: 4px;
  display: flex; align-items: center; justify-content: center;
  font-size: 11px; font-weight: 900; color: white; flex-shrink: 0; letter-spacing: 0;
}
.player-icon.p1 { background: linear-gradient(135deg, var(--p1), var(--p1-light)); box-shadow: 0 0 8px var(--p1-dim); }
.player-icon.p2 { background: linear-gradient(135deg, var(--p2), var(--p2-light)); box-shadow: 0 0 8px var(--p2-dim); }
.player-name { font-size: clamp(10px, 2.2vw, 12px); font-weight: 700; color: var(--text-dim); white-space: nowrap; letter-spacing: 2px; text-transform: uppercase; }
.turn-badge {
  display: inline-block; font-size: 8px; font-weight: 700; padding: 2px 6px;
  border-radius: 3px; margin-left: 4px; opacity: 0; transition: opacity 0.3s; letter-spacing: 2px; flex-shrink: 0;
}
.player-panel.active .turn-badge { opacity: 1; }
.player-panel.p1 .turn-badge { background: var(--p1-glow); color: var(--p1-light); border: 1px solid var(--p1-dim); }
.player-panel.p2 .turn-badge { background: var(--p2-glow); color: var(--p2-light); border: 1px solid var(--p2-dim); }
.wall-indicators { display: flex; gap: 2px; align-items: center; margin-left: auto; }
.wall-pip { width: 6px; height: 16px; border-radius: 2px; transition: all 0.3s; }
.player-panel.p1 .wall-pip { background: var(--p1); box-shadow: 0 0 6px var(--p1-dim); }
.player-panel.p2 .wall-pip { background: var(--p2); box-shadow: 0 0 6px var(--p2-dim); }
.wall-pip.used { background: rgba(255,255,255,0.06) !important; box-shadow: none !important; }
.wall-label { font-size: 14px; font-weight: 900; margin-left: 6px; letter-spacing: 1px; }
.player-panel.p1 .wall-label { color: var(--p1-light); text-shadow: 0 0 8px var(--p1-dim); }
.player-panel.p2 .wall-label { color: var(--p2-light); text-shadow: 0 0 8px var(--p2-dim); }
.wall-pip.used + .wall-label { }
.wall-count-zero .wall-label { color: #ff2222 !important; text-shadow: 0 0 8px rgba(255,0,0,0.3) !important; animation: pulse-urgent 0.5s ease-in-out infinite; }

.timer-area { display: flex; align-items: center; gap: 6px; margin-top: 3px; }
.timer-bar-bg { flex: 1; height: 3px; border-radius: 1px; background: rgba(255,255,255,0.04); overflow: hidden; }
.timer-bar-fill { height: 100%; border-radius: 1px; transition: width 0.25s linear, background 0.5s; width: 100%; }
.player-panel.p1 .timer-bar-fill { background: linear-gradient(90deg, var(--p1), var(--p1-light)); box-shadow: 0 0 6px var(--p1-dim); }
.player-panel.p2 .timer-bar-fill { background: linear-gradient(90deg, var(--p2), var(--p2-light)); box-shadow: 0 0 6px var(--p2-dim); }
.timer-bar-fill.urgent { background: linear-gradient(90deg, #ff0000, #ff4444) !important; animation: pulse-urgent 0.5s ease-in-out infinite; }
@keyframes pulse-urgent { 0%,100% { opacity: 1; } 50% { opacity: 0.5; } }
.timer-text { font-size: 10px; font-weight: 700; font-variant-numeric: tabular-nums; min-width: 22px; text-align: right; color: #556; transition: color 0.3s; letter-spacing: 1px; }
.timer-text.urgent { color: #ff2222; }
.player-panel:not(.active) .timer-area { opacity: 0.3; }

.controls { display: flex; align-items: center; gap: 4px; justify-content: center; width: 100%; }
.ctrl-btn {
  position: relative; flex: 1; padding: 10px 6px; border: 1px solid var(--panel-border); border-radius: 4px;
  background: var(--panel-bg); color: var(--text-dim); font-family: inherit;
  font-size: 13px; font-weight: 700; cursor: pointer; transition: all 0.25s; letter-spacing: 1px;
  -webkit-tap-highlight-color: transparent; touch-action: manipulation; min-height: 44px;
  text-align: center;
}
.ctrl-btn:active { transform: scale(0.95); }
.ctrl-btn.active-move { border-color: var(--move-color); color: var(--move-color); background: var(--move-bg); box-shadow: 0 0 12px var(--move-glow); }
.ctrl-btn.active-wall { border-color: var(--wall-ui-color); border-width: 2px; color: var(--wall-ui-color); background: rgba(255,200,0,0.2); box-shadow: 0 0 16px var(--wall-ui-color), inset 0 0 8px rgba(255,200,0,0.15); text-shadow: 0 0 6px var(--wall-ui-color); }
.ctrl-btn .kbd { display: inline-block; font-size: 8px; padding: 1px 4px; border-radius: 2px; background: rgba(255,255,255,0.05); color: #445; margin-left: 4px; font-weight: 400; vertical-align: 1px; }
@media (hover: none) and (pointer: coarse) { .ctrl-btn .kbd { display: none; } }
.ctrl-divider { width: 1px; height: 24px; background: var(--panel-border); margin: 0 1px; }
.controls.inactive { opacity: 0.25; pointer-events: none; }

#board-container {
  position: relative; -webkit-user-select: none; user-select: none; touch-action: none;
  width: 100%; display: flex; justify-content: center; flex: 1; align-items: center; min-height: 0;
}
canvas#board {
  display: block; border-radius: 6px; cursor: pointer;
  box-shadow: 0 4px 30px rgba(0,0,0,0.6), 0 0 40px var(--board-glow);
  max-width: 100%; max-height: 100%; touch-action: none;
}

.center-controls { display: flex; gap: 8px; align-items: center; justify-content: center; flex-shrink: 0; }
.sound-btn {
  width: 38px; height: 38px; border: 1px solid var(--panel-border); border-radius: 4px;
  background: var(--panel-bg); color: var(--text-dim); font-size: 16px; cursor: pointer;
  transition: all 0.2s; display: flex; align-items: center; justify-content: center;
  -webkit-tap-highlight-color: transparent; touch-action: manipulation; position: relative;
}
.sound-btn:active { transform: scale(0.9); }
.sound-btn.muted { color: #ff2222; }

#reset-btn {
  padding: 8px 20px; border: 1px solid var(--panel-border); border-radius: 4px;
  background: var(--panel-bg); color: var(--text-dim); font-family: inherit;
  font-size: 10px; font-weight: 600; cursor: pointer; transition: all 0.25s;
  -webkit-tap-highlight-color: transparent; touch-action: manipulation;
  min-height: 38px; letter-spacing: 2px; text-transform: uppercase;
}
#reset-btn:active { transform: scale(0.95); background: rgba(255,0,0,0.1); }

#message { font-size: 12px; min-height: 18px; text-align: center; color: var(--wall-ui-color); font-weight: 700; letter-spacing: 1px; flex-shrink: 0; }

.winner-overlay {
  position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0);
  display: flex; justify-content: center; align-items: center; z-index: 100;
  pointer-events: none; transition: background 0.8s; overflow: hidden;
}
.winner-overlay.show { background: rgba(0,4,12,0.85); -webkit-backdrop-filter: blur(16px); backdrop-filter: blur(16px); pointer-events: auto; }
.winner-box {
  background: linear-gradient(145deg, rgba(10,20,40,0.95), rgba(5,10,25,0.95)); border-radius: 12px; padding: 40px 44px; text-align: center;
  border: 1px solid var(--panel-border);
  box-shadow: 0 20px 80px rgba(0,0,0,0.8), 0 0 60px var(--board-glow);
  transform: scale(0.5) rotate(-5deg); opacity: 0;
  transition: all 0.6s cubic-bezier(.2,.8,.3,1.2); margin: 16px; max-width: 340px; width: 90%;
}
.winner-overlay.show .winner-box { transform: scale(1) rotate(0deg); opacity: 1; }
.winner-box .trophy { font-size: 64px; margin-bottom: 12px; animation: trophy-bounce 0.8s ease-out 0.5s both; filter: drop-shadow(0 0 20px var(--wall-ui-color)); }
@keyframes trophy-bounce { 0% { transform: scale(0) rotate(-30deg); } 50% { transform: scale(1.3) rotate(5deg); } 70% { transform: scale(0.9) rotate(-3deg); } 100% { transform: scale(1) rotate(0deg); } }
.winner-box h2 { font-size: clamp(24px, 6vw, 32px); font-weight: 900; margin-bottom: 6px; letter-spacing: 6px; text-transform: uppercase; }
.winner-box h2.win-p1 { color: var(--p1-light); text-shadow: 0 0 20px var(--p1-dim), 0 0 40px var(--p1-glow); animation: saber-glow 1.5s ease-in-out infinite alternate; }
.winner-box h2.win-p2 { color: var(--p2-light); text-shadow: 0 0 20px var(--p2-dim), 0 0 40px var(--p2-glow); animation: saber-glow 1.5s ease-in-out infinite alternate; }
@keyframes saber-glow { 0% { filter: brightness(1); } 100% { filter: brightness(1.3); } }
.winner-box .win-label { font-size: clamp(12px, 3vw, 16px); font-weight: 700; margin-bottom: 16px; letter-spacing: 3px; }
.winner-box p { color: #445566; font-size: 12px; margin-bottom: 24px; letter-spacing: 1px; }
.winner-box button {
  padding: 16px 44px; border: 1px solid var(--panel-border); border-radius: 6px;
  background: linear-gradient(135deg, rgba(0,50,150,0.4), rgba(0,80,200,0.3)); color: #88bbff; font-family: inherit;
  font-size: 13px; font-weight: 700; cursor: pointer; letter-spacing: 2px;
  -webkit-tap-highlight-color: transparent; touch-action: manipulation; min-height: 52px;
  transition: all 0.2s; text-transform: uppercase;
}
.winner-box button:active { transform: scale(0.93); }
.confetti { position: absolute; width: 10px; height: 10px; border-radius: 2px; animation: confetti-fall linear forwards; pointer-events: none; }
@keyframes confetti-fall { 0% { transform: translateY(-10px) rotate(0deg); opacity: 1; } 100% { transform: translateY(110vh) rotate(720deg); opacity: 0; } }

.start-overlay {
  position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #000;
  display: flex; justify-content: center; align-items: center; z-index: 200; flex-direction: column;
}
.start-box { text-align: center; padding: 20px; animation: fadeInUp 1.5s ease-out; }
@keyframes fadeInUp { 0% { opacity: 0; transform: translateY(30px); } 100% { opacity: 1; transform: translateY(0); } }
.start-subtitle { font-size: clamp(10px, 2.5vw, 13px); color: var(--text-dim); letter-spacing: 4px; margin-bottom: 8px; font-weight: 400; }
.start-box h2 {
  font-size: clamp(28px, 8vw, 44px); font-weight: 900; letter-spacing: clamp(6px, 2vw, 14px);
  color: var(--title-color); text-shadow: 0 0 30px var(--title-glow);
  margin-bottom: 8px;
}
.start-box .tagline { color: var(--text-dim); font-size: clamp(10px, 2.5vw, 12px); margin-bottom: 40px; letter-spacing: 3px; }
.start-box button {
  padding: 16px 48px; border: 1px solid var(--title-glow); border-radius: 6px;
  background: var(--start-btn-bg, rgba(0,0,0,0.3)); color: var(--title-color); font-family: inherit;
  font-size: 14px; font-weight: 700; cursor: pointer; letter-spacing: 3px;
  -webkit-tap-highlight-color: transparent; touch-action: manipulation; min-height: 52px;
  text-transform: uppercase; transition: all 0.3s; box-shadow: 0 0 20px var(--title-glow);
}
.start-box button:active { transform: scale(0.95); }
.hidden { display: none; }

#theme-name {
  position: fixed; top: 8px; right: 8px; font-size: 8px; color: rgba(255,255,255,0.15);
  letter-spacing: 2px; z-index: 2; pointer-events: none;
}
</style>
</head>
<body>

<div id="theme-name"></div>

<div class="start-overlay" id="start-overlay">
  <div class="start-box">
    <div class="start-subtitle" id="start-subtitle"></div>
    <h2>QUORIDOR</h2>
    <p class="tagline">2 PLAYER DUEL</p>
    <button onclick="startGame()">START</button>
  </div>
</div>

<div id="app">
  <div class="player-zone p2-zone">
    <div class="controls inactive" id="controls-p2">
      <button class="ctrl-btn active-move" id="btn-move-p2" onclick="setMode('move')">MOVE</button>
      <button class="ctrl-btn" id="btn-wall-p2" onclick="setMode('wall')">WALL</button>
    </div>
    <div class="player-panel p2" id="p2-panel">
      <div class="panel-row">
        <div class="player-icon p2">II</div>
        <span class="player-name" id="p2-name">P2</span>
        <span class="turn-badge">TURN</span>
        <div class="wall-indicators" id="p2-walls"></div>
      </div>
      <div class="timer-area">
        <div class="timer-bar-bg"><div class="timer-bar-fill" id="p2-timer-bar"></div></div>
        <span class="timer-text" id="p2-timer-text">30</span>
      </div>
    </div>
  </div>

  <div id="board-container"><canvas id="board"></canvas></div>
  <div id="message"></div>

  <div class="center-controls">
    <button class="sound-btn" id="sound-btn" onclick="toggleSound()" title="BGM ON/OFF">&#9835;</button>
    <button id="reset-btn" onclick="resetGame()">RESET</button>
  </div>

  <div class="player-zone p1-zone">
    <div class="player-panel p1 active" id="p1-panel">
      <div class="panel-row">
        <div class="player-icon p1">I</div>
        <span class="player-name" id="p1-name">P1</span>
        <span class="turn-badge">TURN</span>
        <div class="wall-indicators" id="p1-walls"></div>
      </div>
      <div class="timer-area">
        <div class="timer-bar-bg"><div class="timer-bar-fill" id="p1-timer-bar"></div></div>
        <span class="timer-text" id="p1-timer-text">30</span>
      </div>
    </div>
    <div class="controls" id="controls-p1">
      <button class="ctrl-btn active-move" id="btn-move-p1" onclick="setMode('move')">MOVE</button>
      <button class="ctrl-btn" id="btn-wall-p1" onclick="setMode('wall')">WALL</button>
    </div>
  </div>
</div>

<div class="winner-overlay" id="winner-overlay">
  <div class="winner-box">
    <div class="trophy">&#9876;</div>
    <h2 id="winner-text">VICTORY</h2>
    <div class="win-label" id="winner-player"></div>
    <p id="winner-msg">WELL PLAYED</p>
    <button onclick="resetGame()">REMATCH</button>
  </div>
</div>

<script>
// ============ THEME SYSTEM ============
var THEMES = [
  { // Sunday - EVANGELION
    name: 'EVANGELION', subtitle: '\u4f7f\u5f92\u3001\u8972\u6765', p1name: '\u521d\u53f7\u6a5f', p2name: '\u5f10\u53f7\u6a5f', winMsg: '\u30d1\u30bf\u30fc\u30f3\u9752\uff01\u5168\u54e1\u64a4\u9000\uff01',
    font: "'Orbitron', 'Inter', sans-serif",
    bg: '#050008', star1: 'rgba(180,0,255,0.8)', star2: 'rgba(0,255,100,0.7)', star3: 'rgba(255,100,0,0.6)',
    nebula1: 'rgba(100,0,200,0.06)', nebula2: 'rgba(0,200,50,0.04)',
    p1: '#7b2d8e', p1Light: '#c466ff', p2: '#cc3300', p2Light: '#ff6644',
    wallColor: [0,255,100], boardBg1: '#0a0014', boardBg2: '#0c0020', boardBg3: '#06000e',
    cellFill: 'rgba(40,0,60,0.3)', cellStroke: 'rgba(100,0,200,0.1)',
    moveColor: 'rgba(0,255,150,', validDot: 'rgba(0,255,150,0.5)',
    title: '#00ff88', confetti: ['#7b2d8e','#c466ff','#cc3300','#ff6644','#00ff88','#ff00ff','#ffcc00','#ffffff'],
    bgm: {
      melody: [
        {n:'A3',d:1},{n:'E4',d:0.5},{n:'D4',d:0.5},{n:'C4',d:1},{n:'B3',d:0.5},{n:'C4',d:0.5},
        {n:'A3',d:1.5},{n:'A3',d:0.5},{n:'E4',d:0.5},{n:'D4',d:0.5},{n:'C4',d:0.5},{n:'B3',d:0.5},
        {n:'A3',d:0.75},{n:'G3',d:0.75},{n:'A3',d:1.5}
      ],
      bass: [
        {n:'A2',d:2},{n:'C3',d:2},{n:'A2',d:2},{n:'A2',d:2},{n:'C3',d:1},{n:'D3',d:1},{n:'A2',d:2}
      ],
      tempo: 0.42, type: 'sawtooth'
    }
  },
  { // Monday - DORAEMON
    name: 'DORAEMON', subtitle: '\u3072\u307f\u3064\u9053\u5177\u3067\u52dd\u8ca0\uff01', p1name: '\u30c9\u30e9\u3048\u3082\u3093', p2name: '\u306e\u3073\u592a', winMsg: '\u672a\u6765\u304b\u3089\u6765\u305f\u52dd\u5229\uff01',
    font: "'Zen Maru Gothic', 'Inter', sans-serif",
    bg: '#001428', star1: 'rgba(100,180,255,0.7)', star2: 'rgba(255,255,150,0.6)', star3: 'rgba(200,200,255,0.5)',
    nebula1: 'rgba(0,80,200,0.06)', nebula2: 'rgba(0,150,255,0.04)',
    p1: '#0066cc', p1Light: '#44aaff', p2: '#cc2200', p2Light: '#ff5533',
    wallColor: [255,220,0], boardBg1: '#001830', boardBg2: '#002040', boardBg3: '#001020',
    cellFill: 'rgba(0,30,80,0.3)', cellStroke: 'rgba(0,80,200,0.1)',
    moveColor: 'rgba(255,220,50,', validDot: 'rgba(255,220,50,0.5)',
    title: '#44aaff', confetti: ['#0066cc','#44aaff','#cc2200','#ff5533','#ffdd00','#ffffff','#ff8800','#88ddff'],
    bgm: {
      melody: [
        {n:'C4',d:0.5},{n:'D4',d:0.5},{n:'E4',d:0.5},{n:'G4',d:0.75},{n:'E4',d:0.25},
        {n:'F4',d:0.5},{n:'E4',d:0.5},{n:'D4',d:1},
        {n:'C4',d:0.5},{n:'E4',d:0.5},{n:'G4',d:0.5},{n:'A4',d:0.75},{n:'G4',d:0.25},
        {n:'F4',d:0.5},{n:'E4',d:0.5},{n:'C4',d:1}
      ],
      bass: [
        {n:'C3',d:2},{n:'F3',d:2},{n:'C3',d:2},{n:'G2',d:1},{n:'C3',d:1}
      ],
      tempo: 0.38, type: 'triangle'
    }
  },
  { // Tuesday - ANPANMAN
    name: 'ANPANMAN', subtitle: '\u52c7\u6c17\u3068\u3084\u3055\u3057\u3055\u306e\u6226\u3044', p1name: '\u30a2\u30f3\u30d1\u30f3\u30de\u30f3', p2name: '\u30d0\u30a4\u30ad\u30f3\u30de\u30f3', winMsg: '\u611b\u3068\u52c7\u6c17\u306e\u52dd\u5229\uff01',
    font: "'Zen Maru Gothic', 'Inter', sans-serif",
    bg: '#1a0800', star1: 'rgba(255,200,100,0.8)', star2: 'rgba(255,150,50,0.7)', star3: 'rgba(255,220,180,0.6)',
    nebula1: 'rgba(255,80,0,0.05)', nebula2: 'rgba(200,100,0,0.04)',
    p1: '#cc4400', p1Light: '#ff7733', p2: '#6622aa', p2Light: '#9955dd',
    wallColor: [255,180,60], boardBg1: '#1a0c04', boardBg2: '#201008', boardBg3: '#140a02',
    cellFill: 'rgba(60,30,10,0.3)', cellStroke: 'rgba(150,60,20,0.1)',
    moveColor: 'rgba(255,200,100,', validDot: 'rgba(255,200,100,0.5)',
    title: '#ff8833', confetti: ['#cc4400','#ff7733','#6622aa','#9955dd','#ffcc00','#ffffff','#ff4400','#88ff44'],
    bgm: {
      melody: [
        {n:'F4',d:0.5},{n:'G4',d:0.5},{n:'A4',d:1},{n:'G4',d:0.5},{n:'F4',d:0.5},
        {n:'E4',d:0.5},{n:'D4',d:0.5},{n:'C4',d:1},
        {n:'D4',d:0.5},{n:'E4',d:0.5},{n:'F4',d:0.75},{n:'E4',d:0.25},{n:'D4',d:0.5},{n:'E4',d:0.5},
        {n:'C4',d:1.5}
      ],
      bass: [
        {n:'F2',d:2},{n:'C3',d:2},{n:'D3',d:2},{n:'C3',d:2}
      ],
      tempo: 0.35, type: 'triangle'
    }
  },
  { // Wednesday - STAR WARS
    name: 'GALACTIC EMPIRE', subtitle: 'A GALACTIC STRATEGY GAME', p1name: 'SITH', p2name: 'JEDI', winMsg: 'THE FORCE IS STRONG',
    font: "'Orbitron', 'Inter', sans-serif",
    bg: '#020810', star1: 'rgba(150,180,255,0.8)', star2: 'rgba(255,200,150,0.7)', star3: 'rgba(200,150,255,0.6)',
    nebula1: 'rgba(255,0,0,0.04)', nebula2: 'rgba(0,100,255,0.04)',
    p1: '#cc0000', p1Light: '#ff4444', p2: '#0044cc', p2Light: '#44aaff',
    wallColor: [255,200,0], boardBg1: '#080c18', boardBg2: '#0a1020', boardBg3: '#060a14',
    cellFill: 'rgba(30,50,80,0.25)', cellStroke: 'rgba(60,100,180,0.08)',
    moveColor: 'rgba(0,255,100,', validDot: 'rgba(0,255,100,0.4)',
    title: '#ffcc00', confetti: ['#ff0000','#ff4444','#0066ff','#44aaff','#ffcc00','#ffffff','#ff6600','#00ff88'],
    bgm: {
      melody: [
        {n:'G3',d:0.75},{n:'G3',d:0.75},{n:'G3',d:0.75},
        {n:'Eb3',d:0.5},{n:'Bb3',d:0.25},
        {n:'G3',d:0.75},{n:'Eb3',d:0.5},{n:'Bb3',d:0.25},
        {n:'G3',d:1.5},
        {n:'D4',d:0.75},{n:'D4',d:0.75},{n:'D4',d:0.75},
        {n:'Eb4',d:0.5},{n:'Bb3',d:0.25},
        {n:'F#3',d:0.75},{n:'Eb3',d:0.5},{n:'Bb3',d:0.25},
        {n:'G3',d:1.5}
      ],
      bass: [
        {n:'G2',d:3},{n:'Eb2',d:1.5},{n:'G2',d:1.5},
        {n:'G2',d:3},
        {n:'D3',d:3},{n:'Eb3',d:1.5},{n:'Bb2',d:1.5},
        {n:'G2',d:3}
      ],
      tempo: 0.45, type: 'sawtooth'
    }
  },
  { // Thursday - DRAGON BALL
    name: 'DRAGON BALL', subtitle: '\u30aa\u30e9\u306b\u5143\u6c17\u3092\u308f\u3051\u3066\u304f\u308c\uff01', p1name: '\u609f\u7a7a', p2name: '\u30d9\u30b8\u30fc\u30bf', winMsg: '\u30ab\u30e1\u30cf\u30e1\u6ce2\uff01\uff01\uff01',
    font: "'Orbitron', 'Inter', sans-serif",
    bg: '#0a0400', star1: 'rgba(255,200,50,0.8)', star2: 'rgba(100,200,255,0.7)', star3: 'rgba(255,150,0,0.6)',
    nebula1: 'rgba(255,150,0,0.05)', nebula2: 'rgba(0,100,255,0.04)',
    p1: '#dd8800', p1Light: '#ffbb33', p2: '#0055bb', p2Light: '#3399ee',
    wallColor: [255,100,0], boardBg1: '#100800', boardBg2: '#180c04', boardBg3: '#0c0600',
    cellFill: 'rgba(60,30,0,0.3)', cellStroke: 'rgba(150,80,0,0.1)',
    moveColor: 'rgba(255,220,50,', validDot: 'rgba(255,220,50,0.5)',
    title: '#ffaa00', confetti: ['#dd8800','#ffbb33','#0055bb','#3399ee','#ff4400','#ffff00','#ff6600','#ffffff'],
    bgm: {
      melody: [
        {n:'E4',d:0.5},{n:'E4',d:0.25},{n:'E4',d:0.25},{n:'G4',d:0.5},{n:'E4',d:0.5},
        {n:'D4',d:0.5},{n:'C4',d:0.5},{n:'D4',d:1},
        {n:'E4',d:0.5},{n:'G4',d:0.5},{n:'A4',d:0.5},{n:'G4',d:0.25},{n:'E4',d:0.25},
        {n:'D4',d:0.5},{n:'E4',d:0.5},{n:'C4',d:1}
      ],
      bass: [
        {n:'C3',d:1},{n:'C3',d:1},{n:'G2',d:2},{n:'C3',d:1},{n:'E3',d:1},{n:'G2',d:1},{n:'C3',d:1}
      ],
      tempo: 0.32, type: 'sawtooth'
    }
  },
  { // Friday - MARIO
    name: 'SUPER MARIO', subtitle: "IT'S-A ME, QUORIDOR!", p1name: 'MARIO', p2name: 'LUIGI', winMsg: 'HERE WE GO!!',
    font: "'DotGothic16', 'Inter', sans-serif",
    bg: '#000820', star1: 'rgba(255,200,50,0.8)', star2: 'rgba(100,255,100,0.7)', star3: 'rgba(255,100,100,0.6)',
    nebula1: 'rgba(200,0,0,0.05)', nebula2: 'rgba(0,150,0,0.04)',
    p1: '#cc0000', p1Light: '#ff4444', p2: '#008800', p2Light: '#44cc44',
    wallColor: [255,200,0], boardBg1: '#001030', boardBg2: '#001840', boardBg3: '#000820',
    cellFill: 'rgba(0,20,60,0.3)', cellStroke: 'rgba(50,100,200,0.1)',
    moveColor: 'rgba(255,255,0,', validDot: 'rgba(255,255,0,0.5)',
    title: '#ff4444', confetti: ['#cc0000','#ff4444','#008800','#44cc44','#ffcc00','#ffffff','#ff8800','#00aaff'],
    bgm: {
      melody: [
        {n:'E5',d:0.25},{n:'E5',d:0.25},{n:'E5',d:0.5},{n:'C5',d:0.25},{n:'E5',d:0.25},
        {n:'G5',d:0.5},{n:'G4',d:0.5},
        {n:'C5',d:0.5},{n:'G4',d:0.5},{n:'E4',d:0.5},
        {n:'A4',d:0.5},{n:'B4',d:0.5},{n:'Bb4',d:0.25},{n:'A4',d:0.75},
        {n:'G4',d:0.33},{n:'E5',d:0.33},{n:'G5',d:0.34},{n:'A5',d:0.5},{n:'F5',d:0.25},{n:'G5',d:0.25},
        {n:'E5',d:0.5},{n:'C5',d:0.25},{n:'D5',d:0.25},{n:'B4',d:0.5}
      ],
      bass: [
        {n:'C3',d:1},{n:'G3',d:0.5},{n:'E3',d:0.5},{n:'C3',d:1},{n:'G2',d:1},
        {n:'C3',d:1},{n:'F3',d:1},{n:'G3',d:1},{n:'C3',d:1}
      ],
      tempo: 0.28, type: 'square'
    }
  },
  { // Saturday - JUJUTSU KAISEN
    name: 'JUJUTSU KAISEN', subtitle: '\u9818\u57df\u5c55\u958b', p1name: '\u864e\u6756', p2name: '\u5bbf\u5102', winMsg: '\u7121\u91cf\u7a7a\u51e6\uff01\uff01',
    font: "'Orbitron', 'Inter', sans-serif",
    bg: '#080010', star1: 'rgba(200,100,255,0.8)', star2: 'rgba(255,50,100,0.7)', star3: 'rgba(100,50,200,0.6)',
    nebula1: 'rgba(100,0,200,0.06)', nebula2: 'rgba(200,0,50,0.04)',
    p1: '#1a1aff', p1Light: '#6666ff', p2: '#cc0044', p2Light: '#ff4477',
    wallColor: [180,80,255], boardBg1: '#0a0018', boardBg2: '#0e0024', boardBg3: '#060010',
    cellFill: 'rgba(30,0,50,0.3)', cellStroke: 'rgba(80,0,150,0.1)',
    moveColor: 'rgba(180,100,255,', validDot: 'rgba(180,100,255,0.5)',
    title: '#bb66ff', confetti: ['#1a1aff','#6666ff','#cc0044','#ff4477','#bb66ff','#ffffff','#ff0066','#00ccff'],
    bgm: {
      melody: [
        {n:'E3',d:0.5},{n:'G3',d:0.25},{n:'A3',d:0.25},{n:'B3',d:0.5},{n:'D4',d:0.5},
        {n:'C4',d:0.5},{n:'B3',d:0.25},{n:'A3',d:0.25},{n:'G3',d:1},
        {n:'A3',d:0.5},{n:'B3',d:0.5},{n:'C4',d:0.5},{n:'E4',d:0.5},
        {n:'D4',d:0.5},{n:'C4',d:0.25},{n:'B3',d:0.25},{n:'A3',d:0.5},{n:'E3',d:0.5}
      ],
      bass: [
        {n:'E2',d:2},{n:'A2',d:2},{n:'E2',d:1},{n:'G2',d:1},{n:'A2',d:1},{n:'E2',d:1}
      ],
      tempo: 0.38, type: 'sawtooth'
    }
  }
];

var T; // current theme object
function applyTheme() {
  var day = new Date().getDay(); // 0=Sun ... 6=Sat
  T = THEMES[day];
  var s = document.documentElement.style;
  s.setProperty('--bg', T.bg);
  s.setProperty('--font', T.font);
  s.setProperty('--text', '#c0d0e8');
  s.setProperty('--text-dim', '#556688');
  s.setProperty('--panel-bg', 'rgba(10,20,40,0.7)');
  s.setProperty('--panel-border', 'rgba(100,150,255,0.1)');
  s.setProperty('--p1', T.p1); s.setProperty('--p1-light', T.p1Light);
  s.setProperty('--p1-dim', T.p1 + '4d'); s.setProperty('--p1-glow', T.p1 + '14');
  s.setProperty('--p2', T.p2); s.setProperty('--p2-light', T.p2Light);
  s.setProperty('--p2-dim', T.p2 + '4d'); s.setProperty('--p2-glow', T.p2 + '14');
  s.setProperty('--move-color', T.moveColor + '1)'); s.setProperty('--move-bg', T.moveColor + '0.06)'); s.setProperty('--move-glow', T.moveColor + '0.08)');
  var wc = T.wallColor;
  s.setProperty('--wall-ui-color', 'rgb('+wc[0]+','+wc[1]+','+wc[2]+')');
  s.setProperty('--wall-ui-bg', 'rgba('+wc[0]+','+wc[1]+','+wc[2]+',0.06)');
  s.setProperty('--wall-ui-glow', 'rgba('+wc[0]+','+wc[1]+','+wc[2]+',0.08)');
  s.setProperty('--msg-color', '#ff6644');
  s.setProperty('--board-glow', 'rgba(0,50,150,0.06)');
  // winner-box and btn backgrounds are hardcoded in CSS (gradients in variables can fail in some browsers)
  s.setProperty('--title-color', T.title);
  s.setProperty('--title-glow', T.title + '33');
  s.setProperty('--start-btn-bg', 'linear-gradient(135deg, ' + T.title + '26, ' + T.title + '1a)');
  s.setProperty('--star1', T.star1); s.setProperty('--star2', T.star2); s.setProperty('--star3', T.star3);
  s.setProperty('--nebula1', T.nebula1); s.setProperty('--nebula2', T.nebula2);
  document.getElementById('theme-name').textContent = T.name;
  document.getElementById('start-subtitle').textContent = T.subtitle;
  document.getElementById('p1-name').textContent = T.p1name;
  document.getElementById('p2-name').textContent = T.p2name;
  document.getElementById('winner-msg').textContent = T.winMsg;
  document.body.style.fontFamily = T.font;
}
applyTheme();

// ============ roundRect polyfill ============
(function() {
  if (typeof CanvasRenderingContext2D !== 'undefined' &&
      !CanvasRenderingContext2D.prototype.roundRect) {
    CanvasRenderingContext2D.prototype.roundRect = function(x, y, w, h, radii) {
      var r = typeof radii === 'number' ? radii : (Array.isArray(radii) ? radii[0] : 0);
      if (r > w / 2) r = w / 2;
      if (r > h / 2) r = h / 2;
      this.moveTo(x + r, y);
      this.lineTo(x + w - r, y);
      this.quadraticCurveTo(x + w, y, x + w, y + r);
      this.lineTo(x + w, y + h - r);
      this.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
      this.lineTo(x + r, y + h);
      this.quadraticCurveTo(x, y + h, x, y + h - r);
      this.lineTo(x, y + r);
      this.quadraticCurveTo(x, y, x + r, y);
      this.closePath();
      return this;
    };
  }
})();

// ============ CONSTANTS ============
var GRID = 9;
var TURN_TIME = 30;

function calcBoardSize() {
  var vw = window.innerWidth;
  var vh = window.innerHeight;
  var maxBoard = Math.min(vw - 16, vh * 0.42, 520);
  var cellAndGap = maxBoard / (GRID + (GRID - 1) * 0.16 + 0.6);
  var cell = Math.floor(cellAndGap);
  var gap = Math.max(4, Math.round(cell * 0.16));
  var pad = Math.max(8, Math.round(cell * 0.3));
  return { cell: cell, gap: gap, pad: pad };
}

var CELL, GAP, PAD, BOARD_PX, DPR;
var canvas = document.getElementById('board');
var ctx = canvas.getContext('2d');

function resizeBoard() {
  var s = calcBoardSize();
  CELL = s.cell; GAP = s.gap; PAD = s.pad;
  BOARD_PX = PAD * 2 + GRID * CELL + (GRID - 1) * GAP;
  DPR = window.devicePixelRatio || 1;
  canvas.style.width = BOARD_PX + 'px';
  canvas.style.height = BOARD_PX + 'px';
  canvas.width = Math.round(BOARD_PX * DPR);
  canvas.height = Math.round(BOARD_PX * DPR);
  ctx.setTransform(DPR, 0, 0, DPR, 0, 0);
  draw();
}

// ============ AUDIO ENGINE ============
var audioCtx = null, bgmPlaying = false, bgmMuted = false, bgmGain = null, bgmTimeout = null;

function initAudio() {
  try {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (audioCtx.state === 'suspended') audioCtx.resume();
    bgmGain = audioCtx.createGain();
    bgmGain.gain.value = 0.18;
    bgmGain.connect(audioCtx.destination);
  } catch (e) { audioCtx = null; }
}

function ensureAudioResumed() { if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume(); }

function playNote(freq, startTime, duration, gain, dest, type) {
  if (!audioCtx) return;
  var osc = audioCtx.createOscillator();
  var env = audioCtx.createGain();
  osc.type = type || 'sine';
  osc.frequency.value = freq;
  env.gain.setValueAtTime(0, startTime);
  env.gain.linearRampToValueAtTime(gain, startTime + 0.04);
  env.gain.exponentialRampToValueAtTime(0.001, startTime + duration - 0.02);
  env.gain.setValueAtTime(0, startTime + duration);
  osc.connect(env); env.connect(dest);
  osc.start(startTime); osc.stop(startTime + duration);
}

var NF = {
  'C2':65.41,'D2':73.42,'Eb2':77.78,'E2':82.41,'F2':87.31,'F#2':92.50,'G2':98.00,'A2':110.0,'Bb2':116.54,'B2':123.5,
  'C3':130.8,'D3':146.8,'Eb3':155.56,'E3':164.8,'F3':174.6,'F#3':185.0,'G3':196.0,'A3':220.0,'Bb3':233.08,'B3':246.9,
  'C4':261.6,'D4':293.7,'Eb4':311.13,'E4':329.6,'F4':349.2,'F#4':370.0,'G4':392.0,'A4':440.0,'Bb4':466.16,'B4':493.9,
  'C5':523.3,'D5':587.3,'Eb5':622.25,'E5':659.3,'F5':698.5,'G5':784.0,'A5':880.0,'B5':987.8
};

function scheduleBGMLoop() {
  if (!audioCtx || bgmMuted || !T || !T.bgm) return;
  var bgm = T.bgm, tempo = bgm.tempo, oscType = bgm.type || 'sawtooth';
  var now = audioCtx.currentTime + 0.1, t = now;
  for (var i = 0; i < bgm.melody.length; i++) {
    var dur = bgm.melody[i].d * tempo;
    playNote(NF[bgm.melody[i].n], t, dur * 0.9, 0.10, bgmGain, oscType);
    playNote(NF[bgm.melody[i].n] * 2, t, dur * 0.6, 0.02, bgmGain, 'sine');
    t += dur;
  }
  var melodyLen = t - now, tb = now;
  for (var j = 0; j < bgm.bass.length; j++) {
    var bd = bgm.bass[j].d * tempo;
    if (tb < now + melodyLen) playNote(NF[bgm.bass[j].n], tb, bd * 0.85, 0.08, bgmGain, 'sine');
    tb += bd;
  }
  bgmTimeout = setTimeout(function() { if (bgmPlaying && !bgmMuted) scheduleBGMLoop(); }, melodyLen * 1000 - 100);
}
function startBGM() { if (!audioCtx) return; bgmPlaying = true; bgmMuted = false; bgmGain.gain.value = 0.18; scheduleBGMLoop(); updateSoundBtn(); }
function stopBGM() { bgmPlaying = false; if (bgmTimeout) clearTimeout(bgmTimeout); updateSoundBtn(); }
function toggleSound() { if (!audioCtx) return; ensureAudioResumed(); bgmMuted = !bgmMuted; if (bgmMuted) { bgmGain.gain.value = 0; if (bgmTimeout) clearTimeout(bgmTimeout); } else { bgmGain.gain.value = 0.18; if (bgmPlaying) scheduleBGMLoop(); } updateSoundBtn(); }
function updateSoundBtn() { var btn = document.getElementById('sound-btn'); btn.classList.toggle('muted', bgmMuted); btn.innerHTML = bgmMuted ? '&#9834;<span style="font-size:10px;position:absolute;color:#ff2222">&#10005;</span>' : '&#9835;'; }

function createNoiseBuffer(dur) { if (!audioCtx) return null; var len = audioCtx.sampleRate * dur; var buf = audioCtx.createBuffer(1, len, audioCtx.sampleRate); var d = buf.getChannelData(0); for (var i = 0; i < len; i++) d[i] = Math.random() * 2 - 1; return buf; }

function playMoveSFX() {
  if (!audioCtx) return; ensureAudioResumed(); var now = audioCtx.currentTime;
  var o = audioCtx.createOscillator(); o.type = 'sawtooth'; o.frequency.setValueAtTime(180, now); o.frequency.exponentialRampToValueAtTime(120, now + 0.15);
  var e = audioCtx.createGain(); e.gain.setValueAtTime(0.15, now); e.gain.exponentialRampToValueAtTime(0.001, now + 0.15);
  o.connect(e); e.connect(audioCtx.destination); o.start(now); o.stop(now + 0.15);
  var o2 = audioCtx.createOscillator(); o2.type = 'sine'; o2.frequency.setValueAtTime(600, now); o2.frequency.exponentialRampToValueAtTime(300, now + 0.1);
  var e2 = audioCtx.createGain(); e2.gain.setValueAtTime(0.08, now); e2.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
  o2.connect(e2); e2.connect(audioCtx.destination); o2.start(now); o2.stop(now + 0.1);
}

function playWallSFX() {
  if (!audioCtx) return; ensureAudioResumed(); var now = audioCtx.currentTime;
  var ns = audioCtx.createBufferSource(); ns.buffer = createNoiseBuffer(0.3);
  var lp = audioCtx.createBiquadFilter(); lp.type = 'lowpass'; lp.frequency.setValueAtTime(3000, now); lp.frequency.exponentialRampToValueAtTime(200, now + 0.2);
  var ne = audioCtx.createGain(); ne.gain.setValueAtTime(0.35, now); ne.gain.exponentialRampToValueAtTime(0.001, now + 0.25);
  ns.connect(lp); lp.connect(ne); ne.connect(audioCtx.destination); ns.start(now); ns.stop(now + 0.3);
  var o = audioCtx.createOscillator(); o.type = 'sine'; o.frequency.setValueAtTime(150, now); o.frequency.exponentialRampToValueAtTime(60, now + 0.2);
  var oe = audioCtx.createGain(); oe.gain.setValueAtTime(0.2, now); oe.gain.exponentialRampToValueAtTime(0.001, now + 0.2);
  o.connect(oe); oe.connect(audioCtx.destination); o.start(now); o.stop(now + 0.2);
}
function playTimerWarnSFX() { if (!audioCtx) return; var now = audioCtx.currentTime; var o = audioCtx.createOscillator(); var e = audioCtx.createGain(); o.type = 'square'; o.frequency.value = 440; e.gain.setValueAtTime(0.08, now); e.gain.exponentialRampToValueAtTime(0.001, now + 0.1); o.connect(e); e.connect(audioCtx.destination); o.start(now); o.stop(now + 0.1); }
function playTimeoutSFX() { if (!audioCtx) return; var now = audioCtx.currentTime; for (var i = 0; i < 3; i++) { var o = audioCtx.createOscillator(); var e = audioCtx.createGain(); o.type = 'sawtooth'; o.frequency.value = 300 - i * 80; e.gain.setValueAtTime(0.12, now + i * 0.15); e.gain.exponentialRampToValueAtTime(0.001, now + i * 0.15 + 0.14); o.connect(e); e.connect(audioCtx.destination); o.start(now + i * 0.15); o.stop(now + i * 0.15 + 0.15); } }
function playWinSFX() { if (!audioCtx) return; var now = audioCtx.currentTime; [196.0,261.6,329.6,392.0,523.3].forEach(function(freq, i) { var o = audioCtx.createOscillator(); var e = audioCtx.createGain(); o.type = 'sawtooth'; o.frequency.value = freq; var t = now + i * 0.18; e.gain.setValueAtTime(0, t); e.gain.linearRampToValueAtTime(0.15, t + 0.05); e.gain.exponentialRampToValueAtTime(0.01, t + 0.6); o.connect(e); e.connect(audioCtx.destination); o.start(t); o.stop(t + 0.6); var o2 = audioCtx.createOscillator(); var e2 = audioCtx.createGain(); o2.type = 'sine'; o2.frequency.value = freq * 2; e2.gain.setValueAtTime(0, t); e2.gain.linearRampToValueAtTime(0.05, t + 0.05); e2.gain.exponentialRampToValueAtTime(0.001, t + 0.5); o2.connect(e2); e2.connect(audioCtx.destination); o2.start(t); o2.stop(t + 0.5); }); }

// ============ STATE ============
var players, walls, wallCounts, currentPlayer, mode, orientation, gameOver, hoverWall;
var turnTimeLeft, timerInterval, gameStarted;

function initState() {
  players = [{ row: 8, col: 4 }, { row: 0, col: 4 }];
  walls = []; wallCounts = [10, 10]; currentPlayer = 0; mode = 'move';
  orientation = 'h'; gameOver = false; hoverWall = null; turnTimeLeft = TURN_TIME; gameStarted = false;
}

// ============ TIMER ============
function startTurnTimer() {
  turnTimeLeft = TURN_TIME; clearInterval(timerInterval); var lastWarnAt = -1;
  timerInterval = setInterval(function() {
    if (gameOver) { clearInterval(timerInterval); return; }
    turnTimeLeft -= 0.25;
    if (turnTimeLeft <= 0) { turnTimeLeft = 0; clearInterval(timerInterval); onTimeout(); }
    var sec = Math.ceil(turnTimeLeft);
    if (sec <= 5 && sec !== lastWarnAt && turnTimeLeft > 0) { lastWarnAt = sec; playTimerWarnSFX(); }
    updateTimerUI();
  }, 250);
}
function onTimeout() { playTimeoutSFX(); showMsg('TIME OUT'); currentPlayer = 1 - currentPlayer; mode = 'move'; hoverWall = null; updateUI(); draw(); startTurnTimer(); }

function updateTimerUI() {
  var sec = Math.ceil(turnTimeLeft), pct = (turnTimeLeft / TURN_TIME) * 100, urgent = turnTimeLeft <= 5;
  for (var p = 0; p < 2; p++) {
    var bar = document.getElementById('p' + (p+1) + '-timer-bar');
    var txt = document.getElementById('p' + (p+1) + '-timer-text');
    if (p === currentPlayer) { bar.style.width = pct + '%'; bar.classList.toggle('urgent', urgent); txt.textContent = sec; txt.classList.toggle('urgent', urgent); }
    else { bar.style.width = '100%'; bar.classList.remove('urgent'); txt.textContent = '30'; txt.classList.remove('urgent'); }
  }
}

// ============ COORDINATE HELPERS ============
function cellX(col) { return PAD + col * (CELL + GAP); }
function cellY(row) { return PAD + row * (CELL + GAP); }
function pixelToCell(px, py) { for (var r = 0; r < GRID; r++) for (var c = 0; c < GRID; c++) { var x = cellX(c), y = cellY(r); if (px >= x && px < x + CELL && py >= y && py < y + CELL) return { row: r, col: c }; } return null; }
function pixelToWallSlot(px, py) { var dist = Math.max(CELL * 0.55, 24); for (var r = 0; r < GRID - 1; r++) for (var c = 0; c < GRID - 1; c++) { var cx = cellX(c) + CELL + GAP / 2; var cy = cellY(r) + CELL + GAP / 2; if (Math.abs(px - cx) < dist && Math.abs(py - cy) < dist) return { row: r, col: c }; } return null; }
function autoDetectOrientation(px, py, slot) {
  var intCx = cellX(slot.col) + CELL + GAP / 2;
  var intCy = cellY(slot.row) + CELL + GAP / 2;
  return Math.abs(px - intCx) >= Math.abs(py - intCy) ? 'h' : 'v';
}

// ============ WALL LOGIC ============
function isBlocked(r1, c1, r2, c2) {
  var dr = r2 - r1, dc = c2 - c1;
  for (var i = 0; i < walls.length; i++) { var w = walls[i];
    if (dr === -1 && dc === 0 && w.orient === 'h' && w.row === r1 - 1 && (w.col === c1 || w.col === c1 - 1)) return true;
    if (dr === 1  && dc === 0 && w.orient === 'h' && w.row === r1     && (w.col === c1 || w.col === c1 - 1)) return true;
    if (dc === -1 && dr === 0 && w.orient === 'v' && w.col === c1 - 1 && (w.row === r1 || w.row === r1 - 1)) return true;
    if (dc === 1  && dr === 0 && w.orient === 'v' && w.col === c1     && (w.row === r1 || w.row === r1 - 1)) return true;
  } return false;
}
function wallOverlaps(r, c, o) { for (var i = 0; i < walls.length; i++) { var w = walls[i]; if (w.orient === o && o === 'h' && w.row === r && Math.abs(w.col - c) <= 1) return true; if (w.orient === o && o === 'v' && w.col === c && Math.abs(w.row - r) <= 1) return true; if (w.row === r && w.col === c && w.orient !== o) return true; } return false; }
function canReachGoal(p, extraWalls) {
  var goalRow = p === 0 ? 0 : 8;
  var allWalls = walls.concat(extraWalls || []);
  var visited = []; for (var i = 0; i < GRID; i++) { visited[i] = []; for (var j = 0; j < GRID; j++) visited[i][j] = false; }
  var queue = [{ row: players[p].row, col: players[p].col }];
  visited[players[p].row][players[p].col] = true;
  var dirs = [[-1,0],[1,0],[0,-1],[0,1]];
  while (queue.length) {
    var cur = queue.shift(); if (cur.row === goalRow) return true;
    for (var d = 0; d < 4; d++) { var nr = cur.row + dirs[d][0], nc = cur.col + dirs[d][1];
      if (nr < 0 || nr >= GRID || nc < 0 || nc >= GRID) continue; if (visited[nr][nc]) continue;
      var dr = nr - cur.row, dc = nc - cur.col, blocked = false;
      for (var k = 0; k < allWalls.length; k++) { var w = allWalls[k];
        if (dr === -1 && dc === 0 && w.orient === 'h' && w.row === cur.row - 1 && (w.col === cur.col || w.col === cur.col - 1)) { blocked = true; break; }
        if (dr === 1  && dc === 0 && w.orient === 'h' && w.row === cur.row     && (w.col === cur.col || w.col === cur.col - 1)) { blocked = true; break; }
        if (dc === -1 && dr === 0 && w.orient === 'v' && w.col === cur.col - 1 && (w.row === cur.row || w.row === cur.row - 1)) { blocked = true; break; }
        if (dc === 1  && dr === 0 && w.orient === 'v' && w.col === cur.col     && (w.row === cur.row || w.row === cur.row - 1)) { blocked = true; break; }
      } if (blocked) continue; visited[nr][nc] = true; queue.push({ row: nr, col: nc });
    }
  } return false;
}
function canPlaceWall(r, c, o) { if (r < 0 || r >= GRID - 1 || c < 0 || c >= GRID - 1) return false; if (wallOverlaps(r, c, o)) return false; var tw = { row: r, col: c, orient: o }; return canReachGoal(0, [tw]) && canReachGoal(1, [tw]); }

// ============ MOVEMENT LOGIC ============
function getValidMoves(p) {
  var row = players[p].row, col = players[p].col, opp = players[1 - p], moves = [];
  var dirs = [[-1,0],[1,0],[0,-1],[0,1]];
  for (var d = 0; d < 4; d++) { var dr = dirs[d][0], dc = dirs[d][1], nr = row + dr, nc = col + dc;
    if (nr < 0 || nr >= GRID || nc < 0 || nc >= GRID) continue; if (isBlocked(row, col, nr, nc)) continue;
    if (opp.row === nr && opp.col === nc) { var jr = nr + dr, jc = nc + dc;
      if (jr >= 0 && jr < GRID && jc >= 0 && jc < GRID && !isBlocked(nr, nc, jr, jc)) { moves.push({ row: jr, col: jc }); }
      else { for (var d2 = 0; d2 < 4; d2++) { if (dirs[d2][0] === -dr && dirs[d2][1] === -dc) continue; var djr = nr + dirs[d2][0], djc = nc + dirs[d2][1]; if (djr < 0 || djr >= GRID || djc < 0 || djc >= GRID) continue; if (isBlocked(nr, nc, djr, djc)) continue; moves.push({ row: djr, col: djc }); } }
    } else { moves.push({ row: nr, col: nc }); }
  } return moves;
}

// ============ DRAWING ============
function draw() {
  ctx.clearRect(0, 0, BOARD_PX, BOARD_PX);
  var bg = ctx.createLinearGradient(0, 0, BOARD_PX, BOARD_PX);
  bg.addColorStop(0, T.boardBg1); bg.addColorStop(0.5, T.boardBg2); bg.addColorStop(1, T.boardBg3);
  ctx.fillStyle = bg; ctx.beginPath(); ctx.roundRect(0, 0, BOARD_PX, BOARD_PX, 8); ctx.fill();

  ctx.strokeStyle = 'rgba(60,100,180,0.12)'; ctx.lineWidth = 1;
  ctx.beginPath(); ctx.roundRect(0.5, 0.5, BOARD_PX - 1, BOARD_PX - 1, 8); ctx.stroke();

  var cr = Math.max(2, CELL * 0.08);
  for (var r = 0; r < GRID; r++) for (var c = 0; c < GRID; c++) {
    var x = cellX(c), y = cellY(r);
    ctx.fillStyle = T.cellFill; ctx.beginPath(); ctx.roundRect(x, y, CELL, CELL, cr); ctx.fill();
    ctx.strokeStyle = T.cellStroke; ctx.lineWidth = 0.5; ctx.beginPath(); ctx.roundRect(x, y, CELL, CELL, cr); ctx.stroke();
  }

  // Goal rows
  for (var gc = 0; gc < GRID; gc++) {
    var g1 = ctx.createLinearGradient(0, cellY(0), 0, cellY(0) + CELL);
    g1.addColorStop(0, T.p1 + '1f'); g1.addColorStop(1, T.p1 + '08');
    ctx.fillStyle = g1; ctx.beginPath(); ctx.roundRect(cellX(gc), cellY(0), CELL, CELL, cr); ctx.fill();
    var g2 = ctx.createLinearGradient(0, cellY(8), 0, cellY(8) + CELL);
    g2.addColorStop(0, T.p2 + '08'); g2.addColorStop(1, T.p2 + '1f');
    ctx.fillStyle = g2; ctx.beginPath(); ctx.roundRect(cellX(gc), cellY(8), CELL, CELL, cr); ctx.fill();
  }

  // Valid moves
  if (!gameOver && mode === 'move') {
    var moves = getValidMoves(currentPlayer);
    for (var mi = 0; mi < moves.length; mi++) {
      var mx = cellX(moves[mi].col), my = cellY(moves[mi].row);
      ctx.fillStyle = T.moveColor + '0.08)'; ctx.beginPath(); ctx.roundRect(mx, my, CELL, CELL, cr); ctx.fill();
      ctx.strokeStyle = T.moveColor + '0.35)'; ctx.lineWidth = 1.5; ctx.setLineDash([3, 3]);
      ctx.beginPath(); ctx.roundRect(mx + 1, my + 1, CELL - 2, CELL - 2, cr); ctx.stroke(); ctx.setLineDash([]);
      ctx.fillStyle = T.validDot; ctx.beginPath(); ctx.arc(mx + CELL / 2, my + CELL / 2, Math.max(2, CELL * 0.06), 0, Math.PI * 2); ctx.fill();
    }
  }

  // Show intersection guide dots when in wall mode
  if (!gameOver && mode === 'wall') {
    ctx.save();
    ctx.fillStyle = 'rgba(' + T.wallColor[0] + ',' + T.wallColor[1] + ',' + T.wallColor[2] + ',0.2)';
    for (var ir = 0; ir < GRID - 1; ir++) {
      for (var ic = 0; ic < GRID - 1; ic++) {
        var ix = cellX(ic) + CELL + GAP / 2;
        var iy = cellY(ir) + CELL + GAP / 2;
        ctx.beginPath(); ctx.arc(ix, iy, Math.max(3, GAP * 0.4), 0, Math.PI * 2); ctx.fill();
      }
    }
    ctx.restore();
  }

  for (var wi = 0; wi < walls.length; wi++) drawWall(walls[wi].row, walls[wi].col, walls[wi].orient);
  if (hoverWall && !gameOver) drawWallPreview(hoverWall.row, hoverWall.col, hoverWall.orient, canPlaceWall(hoverWall.row, hoverWall.col, hoverWall.orient));
  drawPlayer(players[0], 0); drawPlayer(players[1], 1);
}

function drawWall(r, c, orient) {
  ctx.save(); var wr = Math.max(2, GAP * 0.3); var wc = T.wallColor;
  if (orient === 'h') {
    var x = cellX(c), y = cellY(r) + CELL, w = CELL * 2 + GAP, h = GAP;
    var grad = ctx.createLinearGradient(x, y, x + w, y);
    grad.addColorStop(0, 'rgba('+wc[0]+','+wc[1]+','+wc[2]+',0.3)'); grad.addColorStop(0.5, 'rgba('+wc[0]+','+wc[1]+','+wc[2]+',0.8)'); grad.addColorStop(1, 'rgba('+wc[0]+','+wc[1]+','+wc[2]+',0.3)');
    ctx.fillStyle = grad; ctx.shadowColor = 'rgba('+wc[0]+','+wc[1]+','+wc[2]+',0.5)'; ctx.shadowBlur = 12;
    ctx.beginPath(); ctx.roundRect(x, y, w, h, wr); ctx.fill();
    ctx.shadowBlur = 0; ctx.fillStyle = 'rgba(255,255,255,0.3)'; ctx.beginPath(); ctx.roundRect(x + w*0.1, y + h*0.25, w*0.8, h*0.5, 1); ctx.fill();
  } else {
    var vx = cellX(c) + CELL, vy = cellY(r), vw = GAP, vh = CELL * 2 + GAP;
    var vgrad = ctx.createLinearGradient(vx, vy, vx, vy + vh);
    vgrad.addColorStop(0, 'rgba('+wc[0]+','+wc[1]+','+wc[2]+',0.3)'); vgrad.addColorStop(0.5, 'rgba('+wc[0]+','+wc[1]+','+wc[2]+',0.8)'); vgrad.addColorStop(1, 'rgba('+wc[0]+','+wc[1]+','+wc[2]+',0.3)');
    ctx.fillStyle = vgrad; ctx.shadowColor = 'rgba('+wc[0]+','+wc[1]+','+wc[2]+',0.5)'; ctx.shadowBlur = 12;
    ctx.beginPath(); ctx.roundRect(vx, vy, vw, vh, wr); ctx.fill();
    ctx.shadowBlur = 0; ctx.fillStyle = 'rgba(255,255,255,0.3)'; ctx.beginPath(); ctx.roundRect(vx + vw*0.25, vy + vh*0.1, vw*0.5, vh*0.8, 1); ctx.fill();
  }
  ctx.restore();
}

function drawWallPreview(r, c, orient, valid) {
  ctx.save(); ctx.globalAlpha = 0.6;
  var color = valid ? T.moveColor + '0.7)' : 'rgba(255,0,0,0.7)';
  ctx.fillStyle = color; ctx.shadowColor = color; ctx.shadowBlur = 14;
  var wr = Math.max(2, GAP * 0.3);
  if (orient === 'h') { ctx.beginPath(); ctx.roundRect(cellX(c), cellY(r) + CELL, CELL * 2 + GAP, GAP, wr); ctx.fill(); }
  else { ctx.beginPath(); ctx.roundRect(cellX(c) + CELL, cellY(r), GAP, CELL * 2 + GAP, wr); ctx.fill(); }
  ctx.restore();
}

function drawPlayer(p, idx) {
  var cx = cellX(p.col) + CELL / 2, cy = cellY(p.row) + CELL / 2;
  var isActive = currentPlayer === idx && !gameOver;
  var pr = CELL * 0.34;
  var colors = idx === 0
    ? { core: T.p1, light: T.p1Light, glow: T.p1, saber: T.p1 }
    : { core: T.p2, light: T.p2Light, glow: T.p2, saber: T.p2 };
  ctx.save();
  if (isActive) {
    var gg = ctx.createRadialGradient(cx, cy, pr * 0.3, cx, cy, pr * 2.2);
    gg.addColorStop(0, colors.glow + '33'); gg.addColorStop(0.5, colors.glow + '0d'); gg.addColorStop(1, colors.glow + '00');
    ctx.fillStyle = gg; ctx.beginPath(); ctx.arc(cx, cy, pr * 2.2, 0, Math.PI * 2); ctx.fill();
  }
  ctx.shadowColor = colors.saber; ctx.shadowBlur = isActive ? pr * 1.2 : pr * 0.5;
  var grad = ctx.createRadialGradient(cx - pr * 0.2, cy - pr * 0.2, pr * 0.05, cx, cy, pr);
  grad.addColorStop(0, '#ffffff'); grad.addColorStop(0.3, colors.light); grad.addColorStop(1, colors.core);
  ctx.fillStyle = grad; ctx.beginPath(); ctx.arc(cx, cy, pr, 0, Math.PI * 2); ctx.fill();
  ctx.shadowColor = 'transparent'; ctx.fillStyle = 'rgba(255,255,255,0.3)';
  ctx.beginPath(); ctx.arc(cx - pr * 0.2, cy - pr * 0.2, pr * 0.35, 0, Math.PI * 2); ctx.fill();
  ctx.strokeStyle = 'rgba(255,255,255,0.15)'; ctx.lineWidth = 1;
  ctx.beginPath(); ctx.arc(cx, cy, pr, 0, Math.PI * 2); ctx.stroke();
  ctx.restore();
}

// ============ UI ============
function renderWallPips(id, count) {
  var el = document.getElementById(id);
  var h = '';
  for (var i = 0; i < 10; i++) h += '<div class="wall-pip' + (i >= count ? ' used' : '') + '"></div>';
  h += '<span class="wall-label">' + count + '/10</span>';
  el.innerHTML = h;
  el.classList.toggle('wall-count-zero', count === 0);
}

function updateUI() {
  document.getElementById('p1-panel').classList.toggle('active', currentPlayer === 0);
  document.getElementById('p2-panel').classList.toggle('active', currentPlayer === 1);
  renderWallPips('p1-walls', wallCounts[0]); renderWallPips('p2-walls', wallCounts[1]);
  for (var pIdx = 0; pIdx < 2; pIdx++) {
    var sfx = pIdx === 0 ? '-p1' : '-p2';
    var isActive = currentPlayer === pIdx;
    document.getElementById('controls' + sfx).classList.toggle('inactive', !isActive);
    document.getElementById('btn-move' + sfx).className = 'ctrl-btn' + (mode === 'move' ? ' active-move' : '');
    document.getElementById('btn-wall' + sfx).className = 'ctrl-btn' + (mode === 'wall' ? ' active-wall' : '');
  }
  updateTimerUI();
}
function setMode(m) {
  if (gameOver) return;
  mode = m; hoverWall = null;
  showMsg(m === 'wall' ? '交差点の近くをタップ：左右→横壁、上下→縦壁' : '');
  updateUI(); draw();
}
function showMsg(text) { document.getElementById('message').textContent = text; }

function showWinner(p) {
  gameOver = true; clearInterval(timerInterval); stopBGM(); playWinSFX();
  var overlay = document.getElementById('winner-overlay');
  var text = document.getElementById('winner-text');
  var playerLabel = document.getElementById('winner-player');
  text.className = p === 0 ? 'win-p1' : 'win-p2'; text.textContent = 'VICTORY';
  playerLabel.className = 'win-label';
  playerLabel.textContent = p === 0 ? T.p1name : T.p2name;
  playerLabel.style.color = p === 0 ? T.p1Light : T.p2Light;
  setTimeout(function() { overlay.classList.add('show'); spawnConfetti(overlay); }, 50);
}

function spawnConfetti(container) {
  var colors = T.confetti;
  var existing = container.querySelectorAll('.confetti');
  for (var i = 0; i < existing.length; i++) existing[i].remove();
  for (var j = 0; j < 60; j++) {
    var el = document.createElement('div'); el.className = 'confetti';
    el.style.left = Math.random() * 100 + '%'; el.style.top = '-10px';
    el.style.background = colors[Math.floor(Math.random() * colors.length)];
    el.style.width = (Math.random() * 8 + 5) + 'px'; el.style.height = (Math.random() * 8 + 5) + 'px';
    el.style.animationDuration = (Math.random() * 2 + 2) + 's'; el.style.animationDelay = (Math.random() * 1.5) + 's';
    container.appendChild(el);
  }
}

function startGame() {
  document.getElementById('start-overlay').classList.add('hidden');
  initAudio(); initState(); gameStarted = true;
  resizeBoard(); showMsg(''); updateUI(); draw(); startBGM(); startTurnTimer();
}

function resetGame() {
  var overlay = document.getElementById('winner-overlay'); overlay.classList.remove('show');
  var confetti = overlay.querySelectorAll('.confetti'); for (var i = 0; i < confetti.length; i++) confetti[i].remove();
  clearInterval(timerInterval); if (bgmTimeout) clearTimeout(bgmTimeout); bgmPlaying = false;
  if (audioCtx) { audioCtx.close().catch(function(){}); audioCtx = null; }
  initState(); gameStarted = true; showMsg(''); updateUI(); draw(); initAudio(); startBGM(); startTurnTimer();
}

// ============ TOUCH & POINTER ============
function getCanvasPos(e) {
  var rect = canvas.getBoundingClientRect(), scaleX = BOARD_PX / rect.width, scaleY = BOARD_PX / rect.height;
  var clientX, clientY;
  if (e.touches && e.touches.length > 0) { clientX = e.touches[0].clientX; clientY = e.touches[0].clientY; }
  else if (e.changedTouches && e.changedTouches.length > 0) { clientX = e.changedTouches[0].clientX; clientY = e.changedTouches[0].clientY; }
  else { clientX = e.clientX; clientY = e.clientY; }
  return { px: (clientX - rect.left) * scaleX, py: (clientY - rect.top) * scaleY };
}

function handleBoardAction(px, py) {
  if (gameOver || !gameStarted) return; ensureAudioResumed();
  if (mode === 'move') {
    var cell = pixelToCell(px, py); if (!cell) return;
    var moves = getValidMoves(currentPlayer);
    var match = null; for (var i = 0; i < moves.length; i++) { if (moves[i].row === cell.row && moves[i].col === cell.col) { match = moves[i]; break; } }
    if (!match) { showMsg('INVALID MOVE'); return; }
    players[currentPlayer].row = match.row; players[currentPlayer].col = match.col; playMoveSFX(); showMsg('');
    if (currentPlayer === 0 && players[0].row === 0) { draw(); updateUI(); showWinner(0); return; }
    if (currentPlayer === 1 && players[1].row === 8) { draw(); updateUI(); showWinner(1); return; }
    currentPlayer = 1 - currentPlayer; updateUI(); draw(); startTurnTimer();
  } else {
    var slot = pixelToWallSlot(px, py); if (!slot) { showMsg('交差点の近くをタップ'); return; }
    if (wallCounts[currentPlayer] <= 0) { showMsg('NO WALLS LEFT'); return; }
    // Auto-detect orientation from tap position
    var autoOrient = autoDetectOrientation(px, py, slot);
    if (!canPlaceWall(slot.row, slot.col, autoOrient)) {
      // Try the other orientation as fallback
      var altOrient = autoOrient === 'h' ? 'v' : 'h';
      if (canPlaceWall(slot.row, slot.col, altOrient)) {
        autoOrient = altOrient;
      } else {
        showMsg('CANNOT PLACE'); return;
      }
    }
    walls.push({ row: slot.row, col: slot.col, orient: autoOrient }); wallCounts[currentPlayer]--;
    playWallSFX(); showMsg(''); mode = 'move'; hoverWall = null;
    currentPlayer = 1 - currentPlayer; updateUI(); draw(); startTurnTimer();
  }
}

canvas.addEventListener('click', function(e) { var pos = getCanvasPos(e); handleBoardAction(pos.px, pos.py); });
canvas.addEventListener('mousemove', function(e) { if (gameOver || mode !== 'wall') { if (hoverWall) { hoverWall = null; draw(); } return; } var pos = getCanvasPos(e); var slot = pixelToWallSlot(pos.px, pos.py); if (slot) { hoverWall = { row: slot.row, col: slot.col, orient: autoDetectOrientation(pos.px, pos.py, slot) }; } else { hoverWall = null; } draw(); });
canvas.addEventListener('mouseleave', function() { hoverWall = null; draw(); });

var touchStartPos = null;
canvas.addEventListener('touchstart', function(e) { e.preventDefault(); touchStartPos = getCanvasPos(e); }, { passive: false });
canvas.addEventListener('touchmove', function(e) { e.preventDefault(); if (mode === 'wall' && !gameOver) { var pos = getCanvasPos(e); var slot = pixelToWallSlot(pos.px, pos.py); if (slot) { hoverWall = { row: slot.row, col: slot.col, orient: autoDetectOrientation(pos.px, pos.py, slot) }; } else { hoverWall = null; } draw(); } }, { passive: false });
canvas.addEventListener('touchend', function(e) { e.preventDefault(); if (!touchStartPos) return; var endPos = getCanvasPos(e); var dx = endPos.px - touchStartPos.px; var dy = endPos.py - touchStartPos.py; if (Math.abs(dx) < CELL * 1.5 && Math.abs(dy) < CELL * 1.5) { handleBoardAction(endPos.px, endPos.py); } hoverWall = null; touchStartPos = null; draw(); }, { passive: false });
canvas.addEventListener('touchcancel', function() { hoverWall = null; touchStartPos = null; draw(); });
document.addEventListener('touchmove', function(e) { if (e.target === canvas || canvas.contains(e.target)) e.preventDefault(); }, { passive: false });

document.addEventListener('keydown', function(e) { if (!gameStarted) return; if (e.key === 'm' || e.key === 'M') setMode('move'); if (e.key === 'w' || e.key === 'W') setMode('wall'); if (e.key === 'r' || e.key === 'R') resetGame(); });

var resizeTimer;
window.addEventListener('resize', function() { clearTimeout(resizeTimer); resizeTimer = setTimeout(function() { if (gameStarted) resizeBoard(); }, 150); });
window.addEventListener('orientationchange', function() { setTimeout(function() { if (gameStarted) resizeBoard(); }, 300); });

// ============ INIT ============
// Force-clear overlays on page load (prevents stale PWA state)
(function() {
  var wo = document.getElementById('winner-overlay');
  wo.classList.remove('show');
  wo.removeAttribute('style');
  var wb = wo.querySelector('.winner-box');
  if (wb) wb.removeAttribute('style');
  var cf = wo.querySelectorAll('.confetti');
  for (var i = 0; i < cf.length; i++) cf[i].remove();
})();
initState(); resizeBoard(); updateUI(); draw();

// ============ CACHE CLEANUP & SERVICE WORKER ============
// Force-clean old caches (v1-v8) so stale cache-first SWs can't block updates
(function() {
  var CURRENT = 'quoridor-v24';
  if ('caches' in window) {
    caches.keys().then(function(keys) {
      var old = keys.filter(function(k) { return k !== CURRENT; });
      if (old.length > 0) {
        Promise.all(old.map(function(k) { return caches.delete(k); })).then(function() {
          // If we cleaned old caches, force SW update and reload
          if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
            navigator.serviceWorker.getRegistration().then(function(reg) {
              if (reg) reg.update();
            });
          }
        });
      }
    });
  }
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js?v=24').then(function(reg) {
      reg.addEventListener('updatefound', function() {
        var newWorker = reg.installing;
        if (newWorker) {
          newWorker.addEventListener('statechange', function() {
            if (newWorker.state === 'activated') location.reload();
          });
        }
      });
    }).catch(function() {});
    navigator.serviceWorker.addEventListener('controllerchange', function() {
      location.reload();
    });
  }
})();
</script>
</body>
</html>
